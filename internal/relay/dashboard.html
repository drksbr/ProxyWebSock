<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Intratun Relay Status</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
</head>
<body class="bg-slate-950 text-slate-100">
  <div class="max-w-6xl mx-auto px-4 py-8 space-y-10">
    <header class="space-y-4">
      <h1 class="text-3xl font-semibold tracking-tight">Intratun Relay</h1>
      <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
          <div class="text-sm text-slate-400">Proxy (HTTP CONNECT)</div>
          <div class="text-lg font-mono mt-1" id="proxyAddr">-</div>
        </div>
        <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
          <div class="text-sm text-slate-400">Secure (WSS / Metrics)</div>
          <div class="text-lg font-mono mt-1" id="secureAddr">-</div>
        </div>
        <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
          <div class="text-sm text-slate-400">SOCKS5</div>
          <div class="text-lg font-mono mt-1" id="socksAddr">-</div>
        </div>
      </div>
      <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
        <div class="text-sm text-slate-400 mb-2">ACME Hosts</div>
        <div class="font-mono text-sm" id="acmeHosts">-</div>
      </div>
    </header>

    <section>
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">Resumo</h2>
        <div class="text-sm text-slate-400">Atualizado <span id="generatedAt">-</span></div>
      </div>
      <div id="summaryCards" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
    </section>

    <section>
      <h2 class="text-xl font-semibold mb-4">Recursos</h2>
      <div class="grid gap-4 lg:grid-cols-2">
        <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4 space-y-2">
          <div class="text-sm text-slate-400">Uso atual</div>
          <div id="resourceStats" class="text-sm text-slate-300 space-y-1"></div>
        </div>
        <div class="space-y-6">
          <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
            <canvas id="cpuChart" height="160"></canvas>
          </div>
          <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
            <canvas id="memChart" height="160"></canvas>
          </div>
        </div>
      </div>
    </section>

    <section>
      <h2 class="text-xl font-semibold mb-4">Agentes</h2>
      <div id="agentList" class="space-y-6"></div>
    </section>
  </div>

  <script>
    window.STATUS_BOOTSTRAP = {{ .Bootstrap }};
  </script>
  <script>
    (function () {
      var pollInterval = 3000;
      var state = { data: window.STATUS_BOOTSTRAP || {} };

      var els = {
        proxy: document.getElementById("proxyAddr"),
        secure: document.getElementById("secureAddr"),
        socks: document.getElementById("socksAddr"),
        acme: document.getElementById("acmeHosts"),
        generated: document.getElementById("generatedAt"),
        summary: document.getElementById("summaryCards"),
        agents: document.getElementById("agentList"),
        resources: document.getElementById("resourceStats")
      };

      var cpuCtx = document.getElementById("cpuChart").getContext("2d");
      var memCtx = document.getElementById("memChart").getContext("2d");
      var cpuChart = null;
      var memChart = null;

      function formatBytes(bytes) {
        if (!bytes || bytes <= 0) {
          return "0 B";
        }
        var units = ["B", "KiB", "MiB", "GiB", "TiB"];
        var value = bytes;
        var idx = 0;
        while (value >= 1024 && idx < units.length - 1) {
          value = value / 1024;
          idx++;
        }
        var precision = idx === 0 ? 0 : 2;
        return value.toFixed(precision) + " " + units[idx];
      }

      function formatPercent(pct) {
        if (pct === null || pct === undefined) {
          return "0%";
        }
        return pct.toFixed(1) + "%";
      }

      function formatRelative(ts) {
        var d = new Date(ts);
        if (isNaN(d.getTime())) {
          return "-";
        }
        var diff = Date.now() - d.getTime();
        if (diff < 0) {
          return "agora";
        }
        var sec = Math.floor(diff / 1000);
        if (sec < 60) {
          return sec + "s atrás";
        }
        var min = Math.floor(sec / 60);
        if (min < 60) {
          return min + "m atrás";
        }
        var hrs = Math.floor(min / 60);
        if (hrs < 24) {
          return hrs + "h atrás";
        }
        var days = Math.floor(hrs / 24);
        return days + "d atrás";
      }

      function escapeHtml(str) {
        return String(str || "").replace(/[&<>\"']/g, function (ch) {
          var map = { "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#039;" };
          return map[ch] || ch;
        });
      }

      function renderSummaryCards(data) {
        var cards = [
          { label: "Agentes Conectados", value: data.metrics.agentsConnected },
          { label: "Streams Ativas", value: data.metrics.activeStreams },
          { label: "Bytes (cliente → intranet)", value: formatBytes(data.metrics.bytesUp) },
          { label: "Bytes (intranet → cliente)", value: formatBytes(data.metrics.bytesDown) },
          { label: "Falhas de Dial", value: data.metrics.dialErrors },
          { label: "Falhas de Autenticação", value: data.metrics.authFailures }
        ];
        var html = "";
        for (var i = 0; i < cards.length; i++) {
          html += '<div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">' +
            '<div class="text-sm text-slate-400">' + cards[i].label + '</div>' +
            '<div class="text-3xl font-semibold mt-1">' + cards[i].value + '</div>' +
            '</div>';
        }
        els.summary.innerHTML = html;
      }

      function renderAgents(data) {
        if (!data.agents || data.agents.length === 0) {
          els.agents.innerHTML = '<div class="rounded-xl border border-dashed border-slate-800 bg-slate-900/40 p-6 text-center text-slate-400">Nenhum agente conectado.</div>';
          return;
        }

        var html = "";
        data.agents.forEach(function (agent) {
          var pacLink = "";
          if (agent.autoConfig) {
            pacLink = '<div class="text-sm"><a class="text-teal-400 hover:text-teal-200" href="' + escapeHtml(agent.autoConfig) + '">Download PAC</a></div>';
          }

          var streamsHtml = "";
          if (agent.streams && agent.streams.length) {
            streamsHtml = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-800 text-sm"><thead class="text-slate-400"><tr>' +
              '<th class="px-3 py-2 text-left">Stream</th>' +
              '<th class="px-3 py-2 text-left">Destino</th>' +
              '<th class="px-3 py-2 text-left">Protocolo</th>' +
              '<th class="px-3 py-2 text-left">Criada</th>' +
              '<th class="px-3 py-2 text-left">⬆ Bytes</th>' +
              '<th class="px-3 py-2 text-left">⬇ Bytes</th>' +
              '</tr></thead><tbody class="divide-y divide-slate-800">';
            streamsHtml += agent.streams.map(function (stream) {
              return '<tr>' +
                '<td class="px-3 py-2 font-mono text-xs">' + escapeHtml(stream.streamId) + '</td>' +
                '<td class="px-3 py-2 font-mono text-xs">' + escapeHtml(stream.target) + '</td>' +
                '<td class="px-3 py-2 uppercase">' + escapeHtml(stream.protocol) + '</td>' +
                '<td class="px-3 py-2 text-slate-300">' + formatRelative(stream.createdAt) + '</td>' +
                '<td class="px-3 py-2 text-slate-300">' + formatBytes(stream.bytesUp) + '</td>' +
                '<td class="px-3 py-2 text-slate-300">' + formatBytes(stream.bytesDown) + '</td>' +
                '</tr>';
            }).join("");
            streamsHtml += '</tbody></table></div>';
          } else {
            streamsHtml = '<div class="text-sm text-slate-400">Nenhum fluxo ativo</div>';
          }

          html += '<div class="rounded-xl border border-slate-800 bg-slate-900/60 p-5 space-y-4">' +
            '<div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">' +
            '<div>' +
            '<div class="text-lg font-semibold">' + escapeHtml(agent.id) + '</div>' +
            '<div class="text-sm text-slate-400">Remoto ' + escapeHtml(agent.remote) + ' · Conectado há ' + formatRelative(agent.connectedAt) + '</div>' +
            pacLink +
            '</div>' +
            '<div class="text-sm text-slate-400">' + (agent.streams ? agent.streams.length : 0) + ' streams ativas</div>' +
            '</div>' +
            streamsHtml +
            '</div>';
        });
        els.agents.innerHTML = html;
      }

      function buildHistory(history, mapper) {
        var labels = [];
        var values = [];
        if (history) {
          history.forEach(function (point) {
            var label = new Date(point.timestamp);
            labels.push(label.toLocaleString());
            values.push(mapper(point));
          });
        }
        return { labels: labels, values: values };
      }

      function ensureCharts(data) {
        var history = data.resources && data.resources.history ? data.resources.history : [];
        var cpuData = buildHistory(history, function (h) { return h.cpuPercent; });
        var memData = buildHistory(history, function (h) { return h.rssBytes / (1024 * 1024); });

        if (!cpuChart) {
          cpuChart = new Chart(cpuCtx, {
            type: "line",
            data: {
              labels: cpuData.labels,
              datasets: [{
                label: "CPU %",
                data: cpuData.values,
                borderColor: "#38bdf8",
                backgroundColor: "rgba(56, 189, 248, 0.15)",
                fill: true,
                tension: 0.1,
                pointRadius: 0
              }]
            },
            options: {
              animation: false,
              scales: {
                x: { ticks: { color: "#94a3b8", maxRotation: 45, minRotation: 45 } },
                y: { beginAtZero: true, ticks: { color: "#94a3b8" } }
              },
              plugins: {
                legend: { labels: { color: "#cbd5f5" } }
              }
            }
          });
        } else {
          cpuChart.data.labels = cpuData.labels;
          cpuChart.data.datasets[0].data = cpuData.values;
          cpuChart.update("none");
        }

        if (!memChart) {
          memChart = new Chart(memCtx, {
            type: "line",
            data: {
              labels: memData.labels,
              datasets: [{
                label: "RSS MiB",
                data: memData.values,
                borderColor: "#f97316",
                backgroundColor: "rgba(249, 115, 22, 0.15)",
                fill: true,
                tension: 0.1,
                pointRadius: 0
              }]
            },
            options: {
              animation: false,
              scales: {
                x: { ticks: { color: "#94a3b8", maxRotation: 45, minRotation: 45 } },
                y: { beginAtZero: true, ticks: { color: "#94a3b8" } }
              },
              plugins: {
                legend: { labels: { color: "#cbd5f5" } }
              }
            }
          });
        } else {
          memChart.data.labels = memData.labels;
          memChart.data.datasets[0].data = memData.values;
          memChart.update("none");
        }
      }

      function renderResources(data) {
        if (!data.resources || !data.resources.current) {
          els.resources.innerHTML = "<div>-</div>";
          return;
        }
        var cur = data.resources.current;
        els.resources.innerHTML =
          '<div>CPU: <span class="font-mono">' + formatPercent(cur.cpuPercent) + "</span></div>" +
          '<div>Memória RSS: <span class="font-mono">' + formatBytes(cur.rssBytes) + "</span></div>" +
          '<div>Goroutines: <span class="font-mono">' + (cur.goroutines || 0) + "</span></div>";
      }

      function renderAll(data) {
        els.proxy.textContent = data.proxyAddr || "desabilitado";
        els.secure.textContent = data.secureAddr || "-";
        els.socks.textContent = data.socksAddr || "desabilitado";
        els.acme.textContent = data.acmeHosts && data.acmeHosts.length ? data.acmeHosts.join(" ") : "-";
        els.generated.textContent = data.generatedAt ? new Date(data.generatedAt).toLocaleString() : "-";

        renderSummaryCards(data);
        renderResources(data);
        renderAgents(data);
        ensureCharts(data);
      }

      function poll() {
        fetch("/status.json", { cache: "no-store" })
          .then(function (res) {
            if (!res.ok) {
              throw new Error("HTTP " + res.status);
            }
            return res.json();
          })
          .then(function (data) {
            state.data = data;
            renderAll(state.data);
          })
          .catch(function (err) {
            console.warn("status refresh failed", err);
          })
          .finally(function () {
            window.setTimeout(poll, pollInterval);
          });
      }

      renderAll(state.data);
      poll();
    })();
  </script>
</body>
</html>
